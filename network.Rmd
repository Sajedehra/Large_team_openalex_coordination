---
title: "Network"
output: html_document
date: "2025-08-27"
---


```{r}
network_temp<- dat|>filter(ref != "")

samp_network_temp<- sample_n(network_temp, 1200)
```



```{r}
library(dplyr)
library(stringr)
library(purrr)
library(tictoc)

bigger_groups <- samp_network_temp|>filter(n_author>=20)

results <- data.frame(
  oa_id = character(),
  num_before = integer(),
  num_after = integer(),
  stringsAsFactors = FALSE
)


tic()
for (i in seq_along(bigger_groups)) {
  
  # Get author IDs for this row
  author_ids <- bigger_groups$oa_id_author[i] |>
    str_split(",\\s*") |>
    unlist() |>
    unique()
  
  # Generate all unique 3-ID combos
  if (length(author_ids) < 3) next  # skip if not enough authors
  combos_3_ids <- combn(author_ids, 3, simplify = FALSE)
  
  # Remove current row from dat
  match_rows <- network_temp |> filter(oa_id != bigger_groups$oa_id[1])
  
  # Check if each row contains any combo (no date filter yet)
  match_rows$matched_combos <- map(match_rows$oa_id_author, function(authors_str) {
    authors_vec <- str_split(authors_str, ",\\s*") |> unlist()
    keep(combos_3_ids, ~ all(.x %in% authors_vec))
  })
  
  # Filter only rows that actually match
  matched <- match_rows |> filter(map_lgl(matched_combos, ~ length(.x) > 0))
  
  # Count before vs after
  current_date <- bigger_groups$pubdate[i]
  num_before <- sum(matched$pubdate <= current_date, na.rm = TRUE)
  num_after  <- sum(matched$pubdate >  current_date, na.rm = TRUE)
  
  # Store results
  results <- rbind(
    results,
    data.frame(
      oa_id = bigger_groups$oa_id[i],
      num_before = num_before,
      num_after = num_after,
      stringsAsFactors = FALSE
    )
  )
}
toc()
```

```{r}
smaller_groups <- samp_network_temp|>filter(n_author<20, n_author>=4)

results_smaller <- data.frame(
  oa_id = character(),
  num_before = integer(),
  num_after = integer(),
  stringsAsFactors = FALSE
)


tic()
for (i in seq_along(smaller_groups)) {
  
  # Get author IDs for this row
  author_ids <- smaller_groups$oa_id_author[i] |>
    str_split(",\\s*") |>
    unlist() |>
    unique()
  
  # Generate all unique 3-ID combos
  if (length(author_ids) < 3) next  # skip if not enough authors
  combos_3_ids <- combn(author_ids, 3, simplify = FALSE)
  
  # Remove current row from dat
  match_rows <- samp_network_temp |> filter(oa_id != smaller_groups$oa_id[1])
  
  # Check if each row contains any combo (no date filter yet)
  match_rows$matched_combos <- map(match_rows$oa_id_author, function(authors_str) {
    authors_vec <- str_split(authors_str, ",\\s*") |> unlist()
    keep(combos_3_ids, ~ all(.x %in% authors_vec))
  })
  
  # Filter only rows that actually match
  matched <- match_rows |> filter(map_lgl(matched_combos, ~ length(.x) > 0))
  
  # Count before vs after
  current_date <- smaller_groups$pubdate[i]
  num_before <- sum(matched$pubdate <= current_date, na.rm = TRUE)
  num_after  <- sum(matched$pubdate >  current_date, na.rm = TRUE)
  
  # Store results
  results_smaller <- rbind(
    results_smaller,
    data.frame(
      oa_id = smaller_groups$oa_id[i],
      num_before = num_before,
      num_after = num_after,
      stringsAsFactors = FALSE
    )
  )
}
toc()
```



```{r}
tempteam<- dat|> filter(n_author>= 20)|> select(oa_id, title, pubdate, n_author, oa_id_author)

teamtbl<- tibble(paper_id<-character(), dyads<-character(), team_id<- character())

teamtbl <- tempteam %>%
  mutate(author_ids = str_split(oa_id_author, "\\s*,\\s*")) %>%
  transmute(paper_id = oa_id, author_ids, pubdate, n_author) %>%
  pmap_dfr(function(paper_id, author_ids, pubdate, n_author) {
    ids <- unique(author_ids[author_ids != ""])
    if (length(ids) < 2) return(tibble())
    mat <- combn(ids, 2)  # 2 x K matrix
    tibble(
      paper_id = paper_id,
      pubdate=pubdate,
      n_author=n_author,
      author1  = mat[1, ],
      author2  = mat[2, ]
    ) %>% mutate(team_id = paste0(paper_id, "_", row_number()))
  })

teamtbl$size<- "big"
teamtbl<-teamtbl[, -3]
saveRDS(teamtbl, "bigteamnetwork.rds")
```


```{r}
tempsmallteam<- dat|> filter(n_author<20, n_author>=3)|> select(oa_id, title, pubdate, n_author, oa_id_author)


teamsmalltbl <- tibble(paper_id = character(),
                  author1  = character(),
                  author2  = character(),
                  team_id  = character(),
                  pubdate  = as.Date(character()))

for (i in seq_len(nrow(tempsmallteam))) {
  author_ids <- str_split(tempsmallteam$oa_id_author[i], ",\\s*")[[1]]
  author_ids <- unique(author_ids[author_ids != ""])
  if (length(author_ids) >= 2) {
    cm <- combn(author_ids, 2)
    df <- tibble(
      paper_id = tempsmallteam$oa_id[i],
      author1  = cm[1, ],
      author2  = cm[2, ],
      team_id  = paste0(tempsmallteam$oa_id[i], "_", seq_len(ncol(cm))),
      pubdate  = as.Date(tempsmallteam$pubdate[i])
    ) %>% select(paper_id, author1, author2, team_id, pubdate)
    teamsmalltbl <- bind_rows(teamsmalltbl, df)
  }
}

teamsmalltbl$size<- "small"
saveRDS(teamsmalltbl, "smallteamnetwork.rds")
```

```{r}
team_table<-rbind(teamtbl, teamsmalltbl)

dup_team<- team_table[
  duplicated(team_table[, 2:3]) |
  duplicated(team_table[, 2:3], fromLast = TRUE), ]

#dup_test<- team_table|> rowwise()|> mutate(dyad = paste(sort(c(author1, author2)), collapse = "_"))|>ungroup()
#dup_test_team<- dup_test[duplicated(dup_test[,7]) |duplicated(dup_test[,7], fromLast = TRUE), ]

'a <- pmin(team_table$author1, team_table$author2)
> b <- pmax(team_table$author1, team_table$author2)
> idx <- duplicated(data.frame(a,b)) | duplicated(data.frame(a,b), fromLast = TRUE)
> dup_team <- team_table[idx, ] '


nested_network <- dup_team |>group_by(author1,author2) |> nest()

nested_network_filter<- nested_network|>filter(map_int(data, nrow) > 1)


nested_network_filter_big <- nested_network_filter |> filter(map_lgl(data,~ any(.x$size == "big")))


#nested_network_check <- nested_network_filter_big |> filter(map_lgl(data,~ any(.x$size == "small")))
 
nested_network_filter_small<- anti_join(nested_network_filter ,nested_network_filter_big, by = c("author1", "author2"))
 
```



```{r}
dyads_detail <- teamtbl %>%
  mutate(a = pmin(author1, author2),
         b = pmax(author1, author2)) %>%
  distinct(paper_id, a, b, pubdate) %>%
  group_by(a, b) %>%
  summarise(
    n_papers   = n_distinct(paper_id),
    paper_ids  = paste(sort(unique(paper_id)), collapse = ", "),
    years      = paste(sort(unique(format(as.Date(pubdate), "%Y"))), collapse = ", "),
    .groups = "drop"
  )

dyads_detail
```


```{r}
networktbl<- tibble()
for (i in seq_along(teamtbl)) {
  
}
```



